---
title: "Spherize CPJUMP1 profiles"
output:
  html_notebook:
    toc: yes
    toc_float: yes
    toc_depth: 3
    number_sections: yes
    theme: lumen
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
params:
  batch: 2020_11_04_CPJUMP1
  experiment: 
    value:
      Metadata_cell_line: U2OS
      Metadata_timepoint: "48"
      Metadata_experiment_type: Compound
      Metadata_experiment_condition: Standard
  data_level: normalized_feature_select_outlier_trimmed
  normalization: whole_plate
---

# Setup

```{r message=FALSE}
library(magrittr)
library(tidyverse)
library(glue)
library(arrow)
library(matric)
```


```{r}
batch <- params$batch
futile.logger::flog.info(glue("Batch = {batch}"))
```

```{r}
experiment <- as.data.frame(params$experiment)

if(!is.null(experiment)) {
  experiment_tag <-
    experiment %>%
    unite("experiment_tag", everything()) %>%
    pull("experiment_tag") %>%
    sort() %>%
    paste(collapse = "_")
} else {
  experiment_tag <- "all"
}

futile.logger::flog.info(glue("Experiment = {experiment_tag}"))
```

# Load

```{r}
profiles_collated_file <- 
  glue("{batch}/{batch}_all_normalized_feature_select_outlier_trimmed.parquet")

profiles <-
  read_parquet(profiles_collated_file) %>%
  inner_join(experiment)

variables <- 
  str_subset(names(profiles), "Metadata_", negate = TRUE)
```

From https://github.com/jump-cellpainting/pilot-cpjump1-analysis/issues/13#issuecomment-799779409

The following plates showed some anomalies, but they were all included in the analysis:
- `BR00116995` had empty fields (no cells)

```{r}
profiles %>%
  group_by(Metadata_Plate) %>%
  tally()
```
```{r}
dmso_profiles <- 
  profiles %>%
  filter(Metadata_control_type == "negcon")

dmso_profiles %>%
  group_by(Metadata_Plate) %>%
  tally()
```

# Plot

```{r}
dimred_profile <-
  function(profiles,
           method = "umap",
           metric = "euclidean") {
    stopifnot(method %in% c("pca", "umap"))
    
    metadata <- get_annotation(profiles) %>% select(-id)

    data_matrix <- drop_annotation(profiles)
    
    if (method == "umap") {
      
      umap_config <- umap::umap.defaults
      
      umap_config$metric <- metric
      
      umap_config$random_state <- 123
      
      umap_obj <- umap::umap(data_matrix, config = umap_config)
      
      dimred_df <- data.frame(umap_obj$layout)
      
      
    } else if (method == "pca") {
      
      pca_obj <- prcomp(data_matrix)
      
      dimred_df <- data.frame(pca_obj$x[,1:10])
      
    }
    
    
    df <-
      bind_cols(metadata,
                dimred_df)
    df
  }

```


```{r}
dmso_pca <- dimred_profile(dmso_profiles, method = "pca")

sd_limit <- 20

ggplot(dmso_pca,
       aes(PC1, PC2, 
           color = Metadata_Plate)) + 
  geom_point() +
  coord_equal() +
  geom_vline(xintercept = sd_limit) + 
  geom_vline(xintercept = -sd_limit) + 
  geom_hline(yintercept = sd_limit) + 
  geom_hline(yintercept = -sd_limit)
  

ggplot(dmso_pca %>% filter(abs(PC1) < sd_limit & abs(PC2) < sd_limit),
       aes(PC1, PC2, color = Metadata_Plate)) + 
  geom_point() + 
  coord_equal()
```

# Clean 

Clean profiles based on plots

```{r}
dmso_outliers <-
  dmso_pca %>% 
  filter(abs(PC1) >= sd_limit | abs(PC2) >= sd_limit) %>% 
  select(Metadata_Plate, Metadata_Well)

profiles <- 
  profiles %>% 
  anti_join(dmso_outliers)

dmso_profiles <- 
  profiles %>%
  filter(Metadata_control_type == "negcon")

dmso_profiles %>%
  group_by(Metadata_Plate) %>%
  tally()
```

# Transform

```{r eval=FALSE}
profiles_spherized <-
  cytominer::whiten(
    population = profiles,
    variables = variables,
    sample = dmso_profiles,
    regularization_param = 1e-5
  )

ggplot(profiles_spherized %>% sample_frac(1),
       aes(PC1, PC2, color = Metadata_Plate)) + geom_point() +
  ggtitle(glue("{experiment_tag}: spherizing using cleaned data"))
```


# Save

```{r eval=FALSE}
profiles_spherized_collated_file <- 
  glue("{batch}/{batch}_{experiment_tag}_spherized.parquet")

profiles_spherized %>%
  write_parquet(profiles_spherized_collated_file)
```
